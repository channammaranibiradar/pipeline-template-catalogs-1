pipeline {
  agent {
    kubernetes {
      cloud 'terralogic-eks-agent'
      namespace 'cloudbees-builds'
      inheritFrom 'jenkins-kaniko-agent'
      defaultContainer 'jnlp'
    }
  }

  environment {
    IMAGE_NAME = "${params.imageName}"
    IMAGE_TAG  = "${BUILD_NUMBER}"

    MAVEN_REPO = 'maven-repo'
    MVN_CACHE_NAME = 'mvn-cache'

    TRIVY_CACHE_DIR = '.trivycache'
    TRIVY_CACHE_NAME = 'trivy-cache'

    KANIKO_CACHE_DIR = '/workspace/.kaniko-cache'
  }

  stages {

    /* ================= CHECKOUT (FIXED) ================= */
    stage('Checkout') {
      steps {
        echo "Repo: ${params.repoUrl}"
        echo "Branch: ${params.branchName}"

        checkout([
          $class: 'GitSCM',
          branches: [[name: "*/${params.branchName}"]],
          userRemoteConfigs: [[
            url: params.repoUrl,
            credentialsId: params.gitCredentials
          ]]
        ])
      }
    }

    /* ================= MAVEN ================= */
    stage('Maven Build') {
      steps {
        sh """
          mvn clean install \
            -Dmaven.repo.local=${MAVEN_REPO}
        """
      }
    }

    /* ================= SONAR ================= */
    stage('SonarQube Scan') {
      steps {
        withSonarQubeEnv('sonar-server') {
          sh """
            mvn sonar:sonar \
              -Dmaven.repo.local=${MAVEN_REPO} \
              -Dsonar.projectKey=${params.sonarProjectKey}
          """
        }
      }
    }

    /* ================= TRIVY ================= */
    stage('Trivy FS Scan') {
      steps {
        catchError(buildResult: 'SUCCESS', stageResult: 'UNSTABLE') {
          sh '''
            mkdir -p trivy-reports
            trivy fs \
              --format table \
              --output trivy-reports/fs.txt .
          '''
        }
      }
    }

    /* ================= KANIKO ================= */
    stage('Kaniko Build & Push') {
      steps {
        container('kaniko') {
          sh '''
            mkdir -p ${KANIKO_CACHE_DIR}
            /kaniko/executor \
              --context /workspace \
              --dockerfile Dockerfile \
              --destination ${IMAGE_NAME}:${IMAGE_TAG} \
              --destination ${IMAGE_NAME}:latest \
              --cache=true \
              --cache-dir=${KANIKO_CACHE_DIR}
          '''
        }
      }
    }

    /* ================= SBOM ================= */
    stage('Generate SBOM') {
      steps {
        sh '''
          trivy fs \
            --format cyclonedx \
            --output trivy-reports/sbom.json .
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts allowEmptyArchive: true,
        artifacts: 'trivy-reports/*'
      deleteDir()
    }
  }
}
